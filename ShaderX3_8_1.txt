这篇文章讨论一种渲染体容积光的技术，是一个对现有游戏使用技术的提升。这个技术基于面片的体渲染方法。这里我们会童工对Dobashi和Nishita技术的数个提升的方法，在ps_2_0着色器支持下可以实现。

场景中的容积光

一般来说，在实时3D图形中，我们使用简单雾模型和粒子系统去模拟光从漂浮在空中颗粒物中散射回来的效果。这些效果对给与我们对规模的感受和增强场景的真实感很重要，但我们可以在硬件上通过复杂的shader和高填充率做得更好。我们将在这章节实现的效果是发光颗粒物的可视化，或者"participating media"在我们的场景中。这些颗粒物密度可能不均匀并且需要有正确的场景阴影，如图8.1.1。
大多数游戏通过绘制容积光边界区域多边形来渲染容积光，这些多边形混合在场景中，当使用恰当的时候，能够给场景一种很好的空中发光颗粒物的感觉。这些多边形被一个随机纹理渲染、缓慢的UV动画来给出一种灰尘在空间中漂浮的感觉。
一些游戏会把金字塔型的光线通过更多的多边形来显示，当摄像机相对于容积光移动的时候这给予了一定的视差效果，因为体内的点被渲染了。渲染容积光的包围体时通常消耗都比较少，但一般没那么方便。这种幻觉在用户相对于容积光移动的时候会被破坏，特别是当容积光被camera的front plane剪裁的时候。
Mech01和James03研究了另外一类方法。这两篇文章讨论了通过增加和减去前后深度来计算特定体积的射线长度从而计算出漂浮物包围体的形状。这是很聪明的技术可以自然地整合在3D多边形场景中，但是他们不允许灯光颜色参数，不均匀的密度，或者复杂的阴影。
这节讨论的方法是基于科学可视化社区中使用的技术，特别是基于面片的体渲染。代替在世界空间和灯光空间中渲染特定的多边形来制作容积光，我们渲染相机空间中固定朝向的多边形以便沿着光线整合光量。
当场景其他部分都被渲染了，一系列垂直于视线方向的面片会被渲染，如图。这些面片通过add的方法渲染到framebuffer中以便积累场景中颗粒物通过每个像素光线摄像视点散射的光。
当你正常渲染的时候，你其实是计算每个给定像素散射到眼睛里面的光量，但你可以通过渲染正常的不透明多边形平面。在半透明体积数据如容积光的情况下，你应该沿着射线统计volume内所有散射的光。这是我们渲染一堆堆砌相机空间取样平面的原因，让你可以取样容积光体积的所有射线。
这些取样平面通过投影一些从光源来的贴图来渲染。这是为了近似每个像素射出射线上的积分，以及反过来，通过每个取样平面。最终结果应该是近似于光线从空中漂浮颗粒物散射到眼睛的光量。
为了我们的目的，我们光线模型是透视的（类似于手电筒和幻灯机）。每个灯光有坐标、方向、上向量，水平与垂直的视场角，以及远近裁面。简单来说每个光都有一个视椎体，就像一个普通3D场景的观察者一样。一个给定的光源只能在它视椎体里产生光。这很重要，因为它意味着我们只需要在视椎体里面取样了。
取样平面的顶点数据每帧都必须变换到眼镜空间的正确位置。这可以通过在vertex shader中进行简单的三线性插值来完成。取样平面的vertex buffer包含一定数量的在z轴上均匀分布切填满单位cube的quad（CD-ROM中的数量是100）。数据通过这种方式存储在vertex buffer中，就可以在vertex shader代码中简单地变换成填满相机空间包围盒的视锥空间。
这个对齐观察空间包围盒被加载到固定存储器中，并且着色器在这包围盒里三线性插值来放置每个顶点。这意味着这些平面定位非常轻巧，因为着色器能使用上述代码正确计算其位置。下图显示了光视锥和与视线垂直的取样平面（观察者在左边）。取样平面填满了与光视锥的view-space-aligned包围盒。

着色取样平面

现在我们沿着视线方向在光视锥中放置好了取样平面，我们应该怎么渲染他们呢。光照等式中有几项，每个都增加真实性和控制力：
光散射
遮罩
阴影
噪声/不均匀

第一项是最复杂的，用于描述假如漂浮物是均匀密度的话有多少光会到达我们的眼睛，剩下三项以不同的方式遮蔽散射光。

光散射

已经有很多人研究了光线如何在粒子中散布以及怎么影响我们看到的。我们都知道在广大户外场景中使用某些雾模型来营造正确的规模感。这在所有飞行模拟或者其他需要渲染大规模户外场景的3D应用中实现。最近，这些算法进一步推进，随着许多形式散射已被纳入可用的模型。不同的项如粒子密度，光和眼睛与特定粒子的距离，角度衰减都对散射到观察者的光量有影响。由于部分因素（如角度衰减）可以烘焙到cookie中（下节讲），而且因为我们打算渲染非均匀密度的粒子，我们忽略其他参数，除了1/distance平方这个光线强度衰减，这是光散射最重要的方面。你可以想象从一个给定粒子散射到我们眼睛的光量是乘以距离的平方，以及光照等式的其他项可能会影响到它。为了说明距离平方倒数的效果，下图展示了一个聚光灯与不同衰减项生成的光锥。图A展示了无衰减的光锥，图B展示了以距离倒数为衰减系数的光锥，图C展示了距离平方倒数为衰减系数的光锥，这效果与现实世界的效果相当。在我们粒子中，我们选择增加一个环境项加到图C的效果中。